<script>
/* ---------------------------------------------------------
   1. SUPABASE
--------------------------------------------------------- */
const SUPABASE_URL = 'https://wsfdavmzvrylwtgecmas.supabase.co';
const SUPABASE_KEY = 'PASTE_ANON_KEY_TÄHÄN';

const supabaseClient = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
);

let hostsData = [];
let sortAsc = true;

/* ---------------------------------------------------------
   2. FETCH
--------------------------------------------------------- */
async function fetchHosts() {
    const { data, error } = await supabaseClient
        .from('hosts')
        .select(`
            id,
            name,
            description,
            price,
            term,
            affiliate_url,
            tiers (
                name,
                price,
                storage,
                websites
            )
        `)
        .order('price', { ascending: true });

    if (error) {
        console.error(error);
        document.getElementById("mainTableBody").innerHTML =
            `<tr><td colspan="5" style="color:red;text-align:center;">
                Failed to load data
            </td></tr>`;
        return;
    }

    hostsData = data ?? [];
    renderTable();
}

/* ---------------------------------------------------------
   3. RENDER
--------------------------------------------------------- */
function renderTable() {
    const tbody = document.getElementById("mainTableBody");
    tbody.innerHTML = "";

    if (hostsData.length === 0) {
        tbody.innerHTML =
            `<tr><td colspan="5" style="text-align:center;">
                No hosts found
            </td></tr>`;
        return;
    }

    hostsData.forEach((h, i) => {
        tbody.insertAdjacentHTML("beforeend", `
            <tr>
                <td class="rank">${i + 1}</td>
                <td>
                    <strong>${h.name}</strong><br>
                    <small style="color:#777">${h.description ?? ""}</small>
                </td>
                <td>
                    <span class="price-tag">
                        ${formatPrice(h.price)}
                    </span>
                </td>
                <td class="col-term">
                    <span class="term-tag">${h.term ?? "-"}</span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn-view" onclick="openModal(${i})">
                            View Plans
                        </button>
                        <a class="btn-visit"
                           href="${h.affiliate_url ?? '#'}"
                           target="_blank" rel="noopener">
                           Visit Site
                        </a>
                    </div>
                </td>
            </tr>
        `);
    });
}

function formatPrice(value) {
    if (value === null || value === undefined) return "-";
    if (value === 0) return "Free";
    return "€" + Number(value).toFixed(2);
}

/* ---------------------------------------------------------
   4. SORT
--------------------------------------------------------- */
function sortHosts(key) {
    sortAsc = !sortAsc;

    hostsData.sort((a, b) => {
        let A = a[key] ?? "";
        let B = b[key] ?? "";

        if (key === "price") {
            return sortAsc ? A - B : B - A;
        }

        return sortAsc
            ? A.localeCompare(B)
            : B.localeCompare(A);
    });

    renderTable();
}

/* ---------------------------------------------------------
   5. MODAL
--------------------------------------------------------- */
const modal = document.getElementById("tierModal");

function openModal(index) {
    const h = hostsData[index];

    document.getElementById("modalTitle").innerText =
        `${h.name} – Plans`;
    document.getElementById("modalDesc").innerText =
        h.description ?? "";
    document.getElementById("modalVisitBtn").href =
        h.affiliate_url ?? "#";

    const tbody = document.getElementById("tierTableBody");
    tbody.innerHTML = "";

    if (!h.tiers || h.tiers.length === 0) {
        tbody.innerHTML =
            `<tr><td colspan="4">No plans available</td></tr>`;
    } else {
        h.tiers
            .sort((a,b) => a.price - b.price)
            .forEach(t => {
                tbody.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td style="text-align:left">${t.name}</td>
                        <td>${formatPrice(t.price)}</td>
                        <td>${t.storage}</td>
                        <td>${t.websites}</td>
                    </tr>
                `);
            });
    }

    modal.style.display = "block";
}

function closeModal() {
    modal.style.display = "none";
}

window.onclick = e => {
    if (e.target === modal) closeModal();
};

/* ---------------------------------------------------------
   INIT
--------------------------------------------------------- */
fetchHosts();
</script>
